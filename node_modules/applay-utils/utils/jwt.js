const jwt = require('jsonwebtoken');
var key = process.env.key;
var keyportal = process.env.keyportal;


var utils = {
  'setKey': (newkey) => { key = newkey; },
  'setKeyPortal': (newkey) => { keyportal = newkey; },
  'checkPortal': (keyCheck) => keyCheck == keyportal,
  'auth': (req, res, next) => {
    const token = req.headers['x-access-token'];
    if (!token) return res.status(401).json({ auth: false, message: 'Sem token definido.' });
    if (!key) return res.status(401).json({ auth: false, message: 'Sem key definida.' });
    jwt.verify(token, key, (err, decoded) => {
      if (err) return res.status(401).json({ auth: false, message: 'Falha na autenticação do token.' });
      req.tokenId = decoded.id;
      next();
    });
  },
  'login': (id, time) => {
    if (!key) return null;
    const token = jwt.sign({ id }, key, {
      expiresIn: time || (60 * 30) // segundos
    });
    return token;
  }
}
module.exports = utils;